<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkAI | Power Builder 2026</title>
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --sidebar-bg: #f3f4f6;
            --border-color: #e5e7eb;
            --text-main: #111827;
            --text-muted: #6b7280;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --chat-user: #eff6ff;
            --chat-ai: #ffffff;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
        }

        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --sidebar-bg: #0f172a;
            --border-color: #374151;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --accent: #60a5fa;
            --chat-user: #1e3a8a;
            --chat-ai: #1f2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', -apple-system, sans-serif; }

        body { background: var(--bg-primary); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- LAYOUT --- */
        #sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        #main-workspace {
            flex: 1;
            display: flex;
            flex-direction: row;
        }

        .pane { height: 100%; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }

        #chat-pane { width: 380px; min-width: 320px; }
        #preview-pane { flex: 1; background: var(--bg-secondary); }

        /* --- UI COMPONENTS --- */
        .header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            color: var(--text-main);
        }

        .btn-primary { background: var(--accent); color: white; border: none; }
        .btn-primary:hover { background: var(--accent-hover); }

        /* --- CHAT SYSTEM --- */
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .msg {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 88%;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .msg-user { align-self: flex-end; background: var(--chat-user); border: 1px solid var(--border-color); }
        .msg-ai { align-self: flex-start; background: var(--chat-ai); border: 1px solid var(--border-color); }

        .thinking { font-style: italic; color: var(--text-muted); font-size: 12px; margin: 8px 16px; }

        .input-area { padding: 16px; border-top: 1px solid var(--border-color); background: var(--bg-primary); }
        #user-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-main);
            resize: none;
            outline: none;
        }

        /* --- PREVIEW & CODE --- */
        .tabs { display: flex; background: var(--sidebar-bg); padding: 6px; gap: 4px; }
        .tab { padding: 6px 16px; cursor: pointer; border-radius: 4px; font-size: 12px; color: var(--text-muted); }
        .tab.active { background: var(--bg-primary); font-weight: bold; color: var(--text-main); }

        #iframe-container { flex: 1; position: relative; }
        iframe { width: 100%; height: 100%; border: none; background: white; }

        #code-editor {
            flex: 1;
            background: var(--code-bg);
            color: var(--code-text);
            padding: 16px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre;
            overflow: auto;
            display: none;
        }

        /* --- PROJECT LIST --- */
        .project-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .project-item:hover { background: var(--border-color); }
        .project-item.active { background: var(--accent); color: white; }

        /* --- SETTINGS MODAL --- */
        #settings-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--bg-primary); padding: 24px; border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); z-index: 100;
            display: none; width: 420px; border: 1px solid var(--border-color);
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 99; display: none;
            backdrop-filter: blur(2px);
        }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }
        .form-input { 
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);
            background: var(--bg-secondary); color: var(--text-main); font-size: 14px;
        }

        /* Syntax Color Ticks */
        .syn-tag { color: #569cd6; }
        .syn-attr { color: #9cdcfe; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="header">
            <strong style="font-size: 18px; letter-spacing: -0.5px;">‚ú® SparkAI</strong>
            <button class="btn" onclick="toggleTheme()" title="Toggle Dark/Light Mode">üåì</button>
        </div>
        <div style="padding: 16px;">
            <button class="btn btn-primary" style="width: 100%; font-weight: 600;" onclick="createNewProject()">+ New Project</button>
        </div>
        <div id="project-list" style="flex: 1; overflow-y: auto;"></div>
        <div style="padding: 16px; border-top: 1px solid var(--border-color);">
            <button class="btn" style="width: 100%; margin-bottom: 8px;" onclick="openSettings()">‚öôÔ∏è Settings</button>
            <button class="btn" style="width: 100%; color: #ef4444;" onclick="clearHistory()">üóë Clear All</button>
        </div>
    </div>

    <div id="main-workspace">
        <div id="chat-pane" class="pane">
            <div class="header"><span>AI Architect</span></div>
            <div id="chat-messages"></div>
            <div id="thinking-indicator" class="thinking" style="display: none;">SparkAI is conceptualizing...</div>
            <div class="input-area">
                <textarea id="user-input" placeholder="Type what you want to build..." rows="3"></textarea>
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="handleSendMessage()">Generate Site</button>
            </div>
        </div>

        <div id="preview-pane" class="pane">
            <div class="tabs">
                <div class="tab active" id="tab-preview" onclick="switchTab('preview')">Live Preview</div>
                <div class="tab" id="tab-code" onclick="switchTab('code')">Source Code</div>
                <div style="flex: 1;"></div>
                <button class="btn" onclick="downloadCode()">üíæ Download .html</button>
            </div>
            <div id="iframe-container">
                <iframe id="preview-frame"></iframe>
                <div id="code-editor"></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeSettings()"></div>
    <div id="settings-modal">
        <h3 style="margin-bottom: 20px;">Builder Configuration</h3>
        
        <div class="form-group">
            <label class="form-label">OpenRouter API Key</label>
            <input type="password" id="api-key" class="form-input" placeholder="sk-or-...">
        </div>
        
        <div class="form-group">
            <label class="form-label">Preset Model</label>
            <select id="model-select" class="form-input">
                <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Free)</option>
                <option value="google/gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                <option value="openai/gpt-5.3-codex">GPT-5.3 Codex</option>
                <option value="anthropic/claude-4.6-sonnet">Claude 4.6 Sonnet</option>
                <option value="deepseek/deepseek-v3.2">DeepSeek V3.2 (Value)</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Custom Model ID (Overrides Preset)</label>
            <input type="text" id="custom-model" class="form-input" placeholder="e.g. meta-llama/llama-3.1-405b">
            <small style="font-size: 10px; color: var(--text-muted);">Leave empty to use the dropdown selection.</small>
        </div>
        
        <button class="btn btn-primary" style="width: 100%; padding: 12px;" onclick="saveSettings()">Apply Changes</button>
    </div>

    <script>
        /* --- CORE LOGIC --- */
        let state = {
            projects: [],
            currentProjectId: null,
            settings: {
                apiKey: '',
                model: 'google/gemini-2.0-flash-exp:free',
                customModel: '',
                theme: 'light'
            }
        };

        const initialHTML = `<!DOCTYPE html><html><head><style>body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background:#f0f2f5;}.card{background:white;padding:2rem;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);text-align:center;}h1{color:#3b82f6;}</style></head><body><div class="card"><h1>SparkAI Online</h1><p>Start a conversation to generate your site!</p></div></body></html>`;

        window.onload = () => {
            const saved = localStorage.getItem('spark_state_v2');
            if (saved) state = JSON.parse(saved);
            applyTheme();
            if (state.projects.length === 0) createNewProject();
            else loadProject(state.currentProjectId || state.projects[0].id);
            renderProjectList();
        };

        function saveToLocal() { localStorage.setItem('spark_state_v2', JSON.stringify(state)); }

        function createNewProject() {
            const id = Date.now().toString();
            state.projects.unshift({ id, name: "Project " + (state.projects.length + 1), messages: [{ role: 'ai', text: "Ready to build. What's the plan?" }], code: initialHTML });
            loadProject(id);
            renderProjectList();
            saveToLocal();
        }

        function loadProject(id) {
            state.currentProjectId = id;
            const p = state.projects.find(x => x.id === id);
            const box = document.getElementById('chat-messages');
            box.innerHTML = '';
            p.messages.forEach(m => appendMessage(m.role, m.text, false));
            updatePreview(p.code);
            renderProjectList();
        }

        async function handleSendMessage() {
            const input = document.getElementById('user-input');
            const val = input.value.trim();
            if (!val) return;

            appendMessage('user', val);
            input.value = '';
            
            const p = state.projects.find(x => x.id === state.currentProjectId);
            p.messages.push({ role: 'user', text: val });

            const th = document.getElementById('thinking-indicator');
            th.style.display = 'block';

            try {
                let code = "";
                if (state.settings.apiKey) {
                    const activeModel = state.settings.customModel.trim() || state.settings.model;
                    code = await callOpenRouter(val, p.code, activeModel);
                } else {
                    await new Promise(r => setTimeout(r, 1500));
                    code = simulateCode(val);
                }
                p.code = code;
                const reply = "Generation complete. View the changes in the preview pane.";
                p.messages.push({ role: 'ai', text: reply });
                appendMessage('ai', reply);
                updatePreview(code);
                saveToLocal();
            } catch (e) {
                appendMessage('ai', "Error: " + e.message);
            } finally { th.style.display = 'none'; }
        }

        async function callOpenRouter(prompt, currentCode, model) {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${state.settings.apiKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: "system", content: "You are a senior full-stack dev. Return ONLY a single block of valid, complete HTML including CSS and JS. Do not explain anything." },
                        { role: "user", content: `Context: ${currentCode}\n\nTask: ${prompt}` }
                    ]
                })
            });
            const data = await res.json();
            if (data.error) throw new Error(data.error.message);
            let content = data.choices[0].message.content;
            return content.replace(/```html|```/g, '').trim();
        }

        function simulateCode(prompt) {
            return `<!DOCTYPE html><html><head><style>body{font-family:sans-serif;margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#fafafa;} .box{background:white;border:2px solid #3b82f6;padding:40px;border-radius:20px;text-align:center;}</style></head><body><div class="box"><h1>Generated Offline</h1><p>Request: ${prompt}</p><small>Connect your API key in settings for real AI power!</small></div></body></html>`;
        }

        /* --- UI HELPERS --- */
        function appendMessage(role, text, scroll = true) {
            const div = document.createElement('div');
            div.className = `msg msg-${role}`;
            div.innerText = text;
            const c = document.getElementById('chat-messages');
            c.appendChild(div);
            if (scroll) c.scrollTop = c.scrollHeight;
        }

        function updatePreview(code) {
            document.getElementById('preview-frame').srcdoc = code;
            document.getElementById('code-editor').innerText = code;
        }

        function switchTab(t) {
            document.getElementById('tab-preview').classList.toggle('active', t === 'preview');
            document.getElementById('tab-code').classList.toggle('active', t === 'code');
            document.getElementById('preview-frame').style.display = t === 'preview' ? 'block' : 'none';
            document.getElementById('code-editor').style.display = t === 'code' ? 'block' : 'none';
        }

        function renderProjectList() {
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            state.projects.forEach(p => {
                const d = document.createElement('div');
                d.className = `project-item ${p.id === state.currentProjectId ? 'active' : ''}`;
                d.innerHTML = `<span onclick="loadProject('${p.id}')">üìÇ ${p.name}</span><span onclick="deleteProject('${p.id}')" style="font-size:10px; opacity:0.5;">‚úï</span>`;
                list.appendChild(d);
            });
        }

        function deleteProject(id) {
            state.projects = state.projects.filter(x => x.id !== id);
            if (state.projects.length === 0) createNewProject();
            else loadProject(state.projects[0].id);
            renderProjectList();
            saveToLocal();
        }

        /* --- SETTINGS & THEME --- */
        function openSettings() {
            document.getElementById('api-key').value = state.settings.apiKey;
            document.getElementById('model-select').value = state.settings.model;
            document.getElementById('custom-model').value = state.settings.customModel || '';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('settings-modal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('settings-modal').style.display = 'none';
        }

        function saveSettings() {
            state.settings.apiKey = document.getElementById('api-key').value;
            state.settings.model = document.getElementById('model-select').value;
            state.settings.customModel = document.getElementById('custom-model').value;
            saveToLocal();
            closeSettings();
        }

        function toggleTheme() {
            state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
            applyTheme();
            saveToLocal();
        }

        function applyTheme() { document.body.setAttribute('data-theme', state.settings.theme); }

        function downloadCode() {
            const p = state.projects.find(x => x.id === state.currentProjectId);
            const blob = new Blob([p.code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = p.name.replace(/\s/g, '_').toLowerCase() + ".html";
            a.click();
        }

        function clearHistory() {
            if (confirm("Delete all projects?")) {
                localStorage.removeItem('spark_state_v2');
                location.reload();
            }
        }
    </script>
</body>
</html>
